# LaTeX to HTML Pipeline - Handover Document

**Last Updated:** January 19, 2026

## 1. Pipeline Design Overview

### Architecture

The LaTeX-to-HTML conversion uses a **unified pipeline** that processes LaTeX source through several stages:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LaTeX Source (.tex)                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Tree-sitter Parser (lambda/tree-sitter-latex/)                             │
│  - Generates Concrete Syntax Tree (CST)                                     │
│  - Grammar: tree-sitter-latex/grammar.js                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  LaTeX Bridge (lambda/tex/tex_latex_bridge.cpp)                             │
│  - parse_latex_ts(): CST → Lambda Mark elements                             │
│  - convert_command(): Expands LaTeX commands to semantic elements           │
│  - Package definitions loaded from lambda/tex/packages/*.pkg.json           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Document Model (lambda/tex/tex_document_model.cpp)                         │
│  - Converts Mark elements to DocElement tree                                │
│  - Handles paragraphs, sections, lists, tables, formatting                  │
│  - build_doc_element(): Main dispatch function                              │
│  - build_inline_content(): Text formatting and special commands             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  HTML Formatter (lambda/tex/tex_document_model.cpp)                         │
│  - doc_element_to_html(): DocElement tree → HTML output                     │
│  - Generates semantic HTML5 with CSS classes                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           HTML Output                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Key Files

| File | Purpose |
|------|---------|
| `lambda/tex/tex_latex_bridge.cpp` | Tree-sitter CST → Mark elements |
| `lambda/tex/tex_document_model.cpp` | Mark elements → DocElement tree, and DocElement → HTML |
| `lambda/tex/tex_document_model.hpp` | DocElement types and structures |
| `lambda/tex/packages/latex_base.pkg.json` | Base LaTeX command definitions |
| `test/test_latexml_compare_gtest.cpp` | HTML comparison tests |

### DocElement Types

The document model uses these element types (defined in `tex_document_model.hpp`):

- `DOCUMENT` - Root document container
- `PARAGRAPH` - Text paragraphs
- `HEADING` - Section headings (h1-h6)
- `TEXT_SPAN` - Inline text with styling
- `LIST` / `LIST_ITEM` - Ordered/unordered lists
- `TABLE` / `TABLE_ROW` / `TABLE_CELL` - Tables
- `CODE_BLOCK` - Verbatim/code environments
- `SPACE` - Whitespace and line breaks
- `RAW_HTML` - Pass-through HTML (for CSS-based features)

---

## 2. What's Implemented

### Test Status

The test file `test/test_latexml_compare_gtest.cpp` validates Lambda's HTML output against **hybrid reference files**.

#### Hybrid Reference Generation

References are generated by `utils/generate_hybrid_refs.py`, which transforms raw converter output to Lambda's canonical hybrid format based on the mapping decisions in `vibe/Latex_Html_Mapping.md`:

```bash
python3 utils/generate_hybrid_refs.py [--clean] [--verbose]
```

**Source priority:**
1. `*.latexjs.html` (latex.js output) → `*.html` (preferred)
2. `*.latexml.html` (LaTeXML output) → `*.html` (fallback if no latexjs)

**Key transformations:**
- latex.js: `<div class="body">` → `<article class="latex-document">`, `<span class="bf">` → `<strong>`, etc.
- LaTeXML: Strip `ltx_` prefixes, extract body content, simplify nested divs

#### Test Fixtures

Tests files from `test/latexml/fixtures/` (169 files total across multiple directories):
- `ams/` - AMS math package tests
- `digestion/` - TeX digestion/parsing tests  
- `expansion/` - Macro expansion tests
- `fonts/` - Font handling tests
- `grouping/` - TeX grouping tests
- `structure/` - Document structure tests
- `latexjs/` - HTML comparison fixtures (most comprehensive)

#### Test Suites

| Suite | Command Filter | Description |
|-------|----------------|-------------|
| **Baseline** | `--gtest_filter="Baseline*"` | Must-pass tests (currently passing) |
| **Extended** | `--gtest_filter="Extended*"` | Work-in-progress tests (may fail) |

All tests use the same hybrid references and normalization logic. The only difference is that Baseline tests must pass (regressions break the build), while Extended tests track progress on new features.

**HTML Output Configuration:**
The pipeline uses `HtmlOutputOptions::hybrid()` which generates clean semantic HTML5:
- Bold: `<strong>`
- Italic: `<em>`
- Monospace: `<code>`
- Headings: `<h1>`, `<h2>`, etc. with minimal classes
- Paragraphs: `<p>` with minimal classes
- Lists: Clean semantic `<ul>`/`<ol>`/`<li>` markup

### Working Features

#### Text Formatting
- `\textbf{}`, `\textit{}`, `\texttt{}`, `\emph{}`
- `\textsc{}`, `\underline{}`, `\textup{}`, `\textsl{}`
- Font declarations: `\bfseries`, `\itshape`, `\ttfamily`, `\scshape`, `\em`
- Nested formatting with proper scope handling

#### Document Structure
- `\section{}`, `\subsection{}`, `\subsubsection{}`
- `\chapter{}` (for book class)
- `\paragraph{}`, `\subparagraph{}`
- Preamble handling (`\documentclass`, `\usepackage`)

#### Environments
- `itemize`, `enumerate`, `description`
- `quote`, `quotation`, `verse`
- `center`, `flushleft`, `flushright`
- `verbatim`, `comment`
- Nested environments

#### Whitespace & Spacing
- Paragraph breaks (`\par`, blank lines)
- Line breaks (`\\`, `\newline`)
- Horizontal spacing:
  - `\quad` → Em Space (U+2003)
  - `\qquad` → Double Em Space
  - `\enspace`, `\enskip` → En Space (U+2002)
  - `\thinspace`, `\,` → Thin Space (U+2009)
  - `\negthinspace` → CSS `<span class="negthinspace">`
  - `\hspace{<length>}` → CSS `margin-right:Xpx`
- Non-breaking space (`~`, `\nobreakspace`)

#### Special Characters & Symbols
- TeX special chars: `\&`, `\%`, `\$`, `\#`, `\_`, `\{`, `\}`
- Dashes: `--` (en-dash), `---` (em-dash)
- Quotes: `` ` ``, `''`, ``` `` ```, `''`
- Ellipsis: `\ldots`, `\dots`
- Ligatures: `ff`, `fi`, `fl`, `ffi`, `ffl`
- Copyright, trademark, registered: `\copyright`, `\trademark`, `\textregistered`
- Special letters: `\ae`, `\oe`, `\ss`, `\o`, `\l`, etc.

#### Diacritics
- Accents: `\'`, `` \` ``, `\^`, `\"`, `\~`, `\=`, `\.`
- Other marks: `\u`, `\v`, `\H`, `\c`, `\d`, `\b`, `\r`, `\k`

#### Groups & Scoping
- Curly brace groups: `{...}`
- Proper scope handling for font declarations
- ZWSP markers for group boundaries

#### Macros (Basic)
- `\newcommand` without arguments
- `\renewcommand` without arguments
- Simple macro expansion

#### Cross-References
- `\label{name}` - Records label with current section ID and number
- `\ref{name}` - Resolves to `<a href="#sec-N">number</a>`
- `\eqref{name}`, `\pageref{name}` - Also supported
- Two-pass resolution handles forward references
- Works with `\section`, `\subsection`, `\subsubsection`, etc.
- Correct hierarchical numbering (e.g., "1", "1.1", "1.2")

---

## 3. Outstanding Issues & Action Plan

### Extended Test Categories (Not Yet Passing)

| Category | Tests | Issue |
|----------|-------|-------|
| `boxes/` | 4 | `\parbox` not implemented |
| `counters/` | 2 | Counter commands not implemented |
| `fonts/04-08` | 5 | Font scope across paragraphs, ligature suppression |
| `groups/03` | 1 | Groups overlapping paragraphs |
| `label-ref/` | 7 | ✅ **IMPLEMENTED** - Cross-references now working |
| `layout-marginpar/` | 3 | Page layout, margin notes |
| `macros/02-06` | 5 | Macros with arguments |
| `spacing/01-04` | 4 | Minor whitespace differences (functionally correct) |

### Priority Action Items

1. **Macros with Arguments** (High Priority)
   - Implement `\newcommand` with mandatory arguments `#1`, `#2`, etc.
   - Implement optional arguments `[#1]`
   - File: `lambda/tex/tex_latex_bridge.cpp`

2. **Cross-References** ✅ **COMPLETED**
   - `\label{name}` registers anchor with current section ID and number
   - `\ref{name}` resolves to hyperlink with section number
   - Two-pass resolution implemented via `pending_refs` mechanism
   - Works with forward/backward references, sections/subsections
   - Files: `lambda/tex/tex_document_model.cpp`, `tex_document_model.hpp`

3. **Vertical Spacing** (Medium Priority)
   - `\vspace{<length>}` with CSS `margin-bottom`
   - `\smallskip`, `\medskip`, `\bigskip`
   - `\smallbreak`, `\medbreak`, `\bigbreak`

4. **Counters** (Low Priority)
   - `\newcounter`, `\setcounter`, `\stepcounter`
   - `\arabic{}`, `\roman{}`, `\Roman{}`, `\alph{}`, `\Alph{}`

5. **Box Commands** (Low Priority)
   - `\parbox[pos][height][inner-pos]{width}{text}`
   - `\mbox{}`, `\makebox{}`, `\fbox{}`

### Known Issues

1. **Whitespace After `<br>`**: The spacing tests show minor differences where expected has `<br> ` (with space) but actual has `<br>` (no space). This is cosmetic and doesn't affect rendering.

2. **Font Scope Across Paragraphs**: Font declarations like `\bfseries` should persist across paragraph breaks within the same group, but currently reset.

3. **Ligature Suppression in `\texttt`**: Monospace text should not use ligatures, but currently does.

---

## 4. How to Test and Debug

### Running Tests

```bash
# Build all test executables
make build-test

# Run Lambda baseline tests (must all pass)
make test-lambda-baseline

# --- Unified HTML Comparison Tests ---
./test/test_latexml_compare_gtest.exe --gtest_filter="Baseline*"    # Must-pass tests
./test/test_latexml_compare_gtest.exe --gtest_filter="Extended*"    # Work-in-progress tests

# --- Run all tests ---
./test/test_latexml_compare_gtest.exe

# --- Specific test pattern ---
./test/test_latexml_compare_gtest.exe --gtest_filter="*spacing_01*"
./test/test_latexml_compare_gtest.exe --gtest_filter="*ams*"
```

### Regenerating Hybrid References

When updating the expected output format or adding new fixtures:

```bash
# Regenerate all hybrid references from latexjs/latexml sources
python3 utils/generate_hybrid_refs.py --clean --verbose
```

### Manual Conversion Testing

```bash
# Convert LaTeX file to HTML
./lambda.exe convert input.tex -f latex -t html -o output.html

# Convert from test fixtures
./lambda.exe convert test/latexml/fixtures/latexjs/fonts/01_bfseries_declaration.tex \
    -f latex -t html -o /tmp/test.html
cat /tmp/test.html

# Output parsed AST in Mark format (useful for debugging parser output)
./lambda.exe convert input.tex -f latex -t mark -o /tmp/ast.mark
cat /tmp/ast.mark
```

### Debugging

Output parsed AST in Mark format (useful for debugging parser output)
```bash
./lambda.exe convert input.tex -f latex -t mark -o /tmp/ast.mark &&
cat /tmp/ast.mark
```

Add debug output in `lambda/tex/tex_document_model.cpp`:
```cpp
log_debug("tag: %s, processing element", tag);
```

View logs:
```bash
cat log.txt | grep "your_prefix"
```

### Test File Locations

| Path | Description |
|------|-------------|
| `test/latexml/fixtures/` | LaTeX test input files (all categories) |
| `test/latexml/expected/` | Hybrid HTML references (`.html` files) |
| `test/latexml/expected/*/*.latexjs.html` | Raw latex.js output (source for hybrid refs) |
| `test/latexml/expected/*/*.latexml.html` | Raw LaTeXML output (fallback source) |
| `test_output/latexml/` | Actual test output (generated during tests) |

### Adding New Baseline Tests

When a test passes consistently, add it to the baseline set in `test/test_latexml_compare_gtest.cpp`:

```cpp
static const std::set<std::string> BASELINE_FIXTURES = {
    // ... existing entries ...
    "latexjs/category/##_test_name",  // Add new passing test (full path from fixtures/)
    "ams/mathtools",                   // Non-latexjs fixtures use same format
};
```

See the `is_baseline_fixture()` function for the current baseline list.

### Key Debugging Points

1. **Parser Output**: Check what the Tree-sitter parser produces
   ```bash
   # In log.txt after conversion
   grep "convert_latex_node" log.txt
   ```

2. **Element Tags**: The document model dispatches on element tag names
   ```cpp
   // In tex_document_model.cpp
   if (tag_eq(tag, "your_command")) {
       // Handle command
   }
   ```

3. **Package Definitions**: Check if command is defined
   ```bash
   grep "your_command" lambda/tex/packages/*.pkg.json
   ```

4. **Build Verification**:
   ```bash
   make build 2>&1 | grep -E "error:|warning:.*tex_"
   ```

---

## Appendix: Unit Conversion Reference

For `\hspace{<length>}` and similar commands:

| Unit | Pixels | Formula |
|------|--------|---------|
| pt | 96/72 = 1.333 | 1pt = 1/72 inch |
| cm | 96/2.54 = 37.795 | 1cm = 1/2.54 inch |
| mm | 96/25.4 = 3.7795 | 1mm = 1/25.4 inch |
| in | 96 | 1in = 96px (CSS standard) |
| em | 16 | Assumed 16px base font |

---

## Reference

For questions about this pipeline, refer to:
- `doc/Lambda_Reference.md` - Lambda language reference
- `.github/copilot-instructions.md` - Project coding conventions
