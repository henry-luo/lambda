#lang racket/base

;; font-metrics.rkt — JSON-based font metrics for Redex layout engine
;;
;; Loads pre-extracted font metrics from JSON files (generated by
;; utils/extract_font_metrics.py) and provides functions for:
;;   - Text width measurement using per-glyph advance widths + kerning
;;   - Line-height calculation using Chrome-compatible vertical metrics
;;   - Font selection (serif/sans-serif/bold → font file mapping)
;;
;; This replaces the hardcoded character-width ratio tables that were
;; previously scattered across reference-import.rkt and layout-dispatch.rkt.

(require racket/match
         racket/string
         racket/list
         racket/path
         json)

(provide ;; font metrics loading
         load-font-metrics!
         font-metrics-loaded?

         ;; text measurement
         measure-text-with-metrics
         char-width-from-metrics

         ;; vertical metrics
         font-line-height-ratio
         font-ascender-ratio
         font-descender-ratio

         ;; font selection
         resolve-font-key
         
         ;; for layout-dispatch inline char-width function
         make-char-width-fn
         
         ;; Chrome macOS line-height computation
         chrome-mac-line-height
         
         ;; direct access (for layout-block strut calculations etc.)
         get-font-metrics)

;; ============================================================
;; Font Metrics Data Structures
;; ============================================================

;; Each loaded font has these fields (from JSON):
;;   - units-per-em: integer (e.g. 2048)
;;   - line-height-ratio: float (Chrome-compatible normal line-height / font-size)
;;   - ascender-ratio: float (hhea.ascender / unitsPerEm)
;;   - descender-ratio: float (|hhea.descender| / unitsPerEm)
;;   - glyph-widths: hash of codepoint-string → advance-width (font units)
;;   - char-width-ratios: hash of codepoint-string → width ratio (0.0-1.0+)
;;   - kern-pairs: hash of "cp1,cp2" → kern value (font units)
;;   - default-ratio: float (fallback width ratio for unmapped glyphs)

(struct font-data
  (name style units-per-em
   line-height-ratio ascender-ratio descender-ratio
   char-width-ratios kern-pairs default-ratio)
  #:transparent)

;; ============================================================
;; Global Font Registry
;; ============================================================

;; font-key → font-data mapping
;; Keys: 'times, 'times-bold, 'arial, 'arial-bold, 'liberation-serif, etc.
(define font-registry (make-hash))

;; whether metrics have been loaded from JSON
(define metrics-loaded? #f)

(define (font-metrics-loaded?) metrics-loaded?)

;; Directory containing font metrics JSON files
(define font-metrics-dir
  (let ([this-dir (path->string (path-only (resolved-module-path-name
                                            (variable-reference->resolved-module-path
                                             (#%variable-reference)))))])
    (build-path this-dir "font-metrics")))

;; ============================================================
;; JSON Loading
;; ============================================================

(define (load-font-metrics!)
  "Load all font metrics JSON files from the font-metrics directory."
  (unless metrics-loaded?
    (define dir font-metrics-dir)
    (when (directory-exists? dir)
      (for ([file (in-list (directory-list dir))])
        (define file-str (path->string file))
        (when (string-suffix? file-str ".json")
          (define full-path (build-path dir file-str))
          (define metrics (load-single-font-json full-path))
          (when metrics
            ;; Register under multiple keys for easy lookup
            (register-font-metrics! metrics file-str)))))
    (set! metrics-loaded? #t)))

(define (load-single-font-json path)
  "Load a single font metrics JSON file and return a font-data struct."
  (with-handlers ([exn:fail? (lambda (e)
                                ;; silently skip files that can't be parsed
                                #f)])
    (define json-data
      (call-with-input-file path
        (lambda (in) (read-json in))))
    (define units-per-em (hash-ref json-data 'units_per_em 2048))
    (define lh-ratio (hash-ref json-data 'line_height_ratio 1.15))
    (define asc-ratio (hash-ref json-data 'ascender_ratio 0.891))
    (define desc-ratio (hash-ref json-data 'descender_ratio 0.216))
    (define name (hash-ref json-data 'font_name "Unknown"))
    (define style (hash-ref json-data 'font_style "Regular"))

    ;; Load char_width_ratios hash: string keys "codepoint" → ratio
    (define raw-ratios (hash-ref json-data 'char_width_ratios (hash)))
    (define char-ratios (make-hash))
    (for ([(k v) (in-hash raw-ratios)])
      ;; k is a symbol like '|32| or just '32
      (define cp-str (symbol->string k))
      (define cp (string->number cp-str))
      (when cp
        (hash-set! char-ratios cp v)))

    ;; Load kern_pairs hash: string keys "cp1,cp2" → kern value in font units
    (define raw-kerns (hash-ref json-data 'kern_pairs (hash)))
    (define kern-pairs (make-hash))
    (for ([(k v) (in-hash raw-kerns)])
      (define key-str (symbol->string k))
      (define parts (string-split key-str ","))
      (when (= (length parts) 2)
        (define cp1 (string->number (car parts)))
        (define cp2 (string->number (cadr parts)))
        (when (and cp1 cp2)
          (hash-set! kern-pairs (cons cp1 cp2) (/ v units-per-em)))))

    ;; Default ratio: space width / units_per_em, or fallback to 0.5
    (define space-ratio (hash-ref char-ratios 32 0.5))  ;; space = codepoint 32
    (define default-ratio
      (cond
        ;; for serif fonts, default to ~0.5
        [(or (string-contains? name "Serif") (string-contains? name "Times"))
         0.500]
        ;; for sans-serif fonts, default to ~0.556
        [(or (string-contains? name "Sans") (string-contains? name "Arial"))
         0.556]
        [else 0.500]))

    (font-data name style units-per-em
               lh-ratio asc-ratio desc-ratio
               char-ratios kern-pairs default-ratio)))

(define (register-font-metrics! fd file-name)
  "Register a font-data under appropriate lookup keys.
   Priority: system fonts (Times New Roman, Arial) > Liberation > other.
   The 'times and 'arial keys are the primary lookup keys used by
   reference-import.rkt and layout-dispatch.rkt."
  (define name (string-downcase (font-data-name fd)))
  (define style (string-downcase (font-data-style fd)))
  (define is-bold? (string-contains? style "bold"))

  ;; Register under file stem (e.g., 'LiberationSerif-Regular)
  (define stem (string->symbol (regexp-replace #rx"\\.json$" file-name "")))
  (hash-set! font-registry stem fd)

  ;; Register under generic font-family keys with priority:
  ;; System fonts (exact name match) always override; Liberation provides fallback.
  ;; Open Sans, Roboto, etc. get their own keys and never claim 'arial/'times.
  (cond
    ;; System Times New Roman (highest priority for 'times)
    [(string-contains? name "times new roman")
     (if is-bold?
         (hash-set! font-registry 'times-bold fd)
         (hash-set! font-registry 'times fd))]
    ;; System Arial (highest priority for 'arial)
    [(equal? name "arial")
     (if is-bold?
         (begin (hash-set! font-registry 'arial-bold fd)
                (hash-set! font-registry 'arial-native-bold fd))
         (begin (hash-set! font-registry 'arial fd)
                (hash-set! font-registry 'arial-native fd)))]
    ;; Liberation Serif → fallback for 'times (only if not already set by system font)
    [(string-contains? name "liberation serif")
     (unless (hash-has-key? font-registry (if is-bold? 'times-bold 'times))
       (if is-bold?
           (hash-set! font-registry 'times-bold fd)
           (hash-set! font-registry 'times fd)))]
    ;; Liberation Sans → fallback for 'arial (only if not already set by system font)
    [(string-contains? name "liberation sans")
     (unless (hash-has-key? font-registry (if is-bold? 'arial-bold 'arial))
       (if is-bold?
           (begin (hash-set! font-registry 'arial-bold fd)
                  (hash-set! font-registry 'arial-native-bold fd))
           (begin (hash-set! font-registry 'arial fd)
                  (hash-set! font-registry 'arial-native fd))))]
    ;; Open Sans → own key only
    [(string-contains? name "open sans")
     (if is-bold?
         (hash-set! font-registry 'open-sans-bold fd)
         (hash-set! font-registry 'open-sans fd))]
    ;; Roboto → own key only
    [(string-contains? name "roboto")
     (if is-bold?
         (hash-set! font-registry 'roboto-bold fd)
         (hash-set! font-registry 'roboto fd))]
    ;; Mono → own key only
    [(string-contains? name "mono")
     (if is-bold?
         (hash-set! font-registry 'mono-bold fd)
         (hash-set! font-registry 'mono fd))]
    [else (void)]))

;; ============================================================
;; Font Selection
;; ============================================================

(define (resolve-font-key font-metrics-sym)
  "Resolve a font-metrics symbol ('times or 'arial) to a font-data struct.
   Falls back to hardcoded defaults if metrics not loaded."
  (load-font-metrics!)  ;; ensure loaded
  (hash-ref font-registry font-metrics-sym #f))

(define (get-font-metrics font-metrics-sym)
  "Get font-data for a font-metrics symbol. Returns #f if not found."
  (load-font-metrics!)
  (hash-ref font-registry font-metrics-sym #f))

;; ============================================================
;; Text Width Measurement
;; ============================================================

(define (char-width-from-metrics ch font-size font-metrics-sym)
  "Get the width of a single character using JSON-loaded metrics.
   Falls back to hardcoded ratios if metrics not available."
  (define fd (resolve-font-key font-metrics-sym))
  (cond
    [fd
     (define cp (char->integer ch))
     (define ratio (hash-ref (font-data-char-width-ratios fd) cp
                             (font-data-default-ratio fd)))
     (* ratio font-size)]
    [else
     ;; fallback: use old hardcoded default
     (* (if (eq? font-metrics-sym 'arial) 0.556 0.500) font-size)]))

(define (make-char-width-fn font-metrics-sym)
  "Create a char-width function for a given font-metrics symbol.
   Returns (lambda (ch font-size) -> width-in-pixels).
   Used by layout-dispatch.rkt for word wrapping."
  (define fd (resolve-font-key font-metrics-sym))
  (cond
    [fd
     (define ratios (font-data-char-width-ratios fd))
     (define default-r (font-data-default-ratio fd))
     (define kerns (font-data-kern-pairs fd))
     (lambda (ch font-size)
       (define cp (char->integer ch))
       (define ratio (hash-ref ratios cp default-r))
       (* ratio font-size))]
    [else
     ;; fallback
     (lambda (ch font-size)
       (* (if (eq? font-metrics-sym 'arial) 0.556 0.500) font-size))]))

(define (measure-text-with-metrics text font-size font-metrics-sym)
  "Measure text width using JSON-loaded font metrics.
   Includes per-character advance widths and kern pair adjustments.
   Falls back to old behavior if metrics not loaded."
  (define fd (resolve-font-key font-metrics-sym))
  (cond
    [fd
     (define ratios (font-data-char-width-ratios fd))
     (define kerns (font-data-kern-pairs fd))
     (define default-r (font-data-default-ratio fd))
     (define total 0)
     (define prev-cp #f)
     (for ([ch (in-string text)])
       (cond
         [(or (char=? ch #\newline) (char=? ch #\return)
              (char=? ch #\u200B) (char=? ch #\u200C)
              (char=? ch #\u200D) (char=? ch #\uFEFF))
          (set! prev-cp #f)]  ;; zero-width / control chars reset kerning
         [else
          (define cp (char->integer ch))
          (define ratio (hash-ref ratios cp default-r))
          (define char-w (* ratio font-size))
          ;; apply kerning if we have a previous character
          (define kern-adj
            (if prev-cp
                (let ([kern-val (hash-ref kerns (cons prev-cp cp) 0)])
                  (* kern-val font-size))
                0))
          (set! total (+ total char-w kern-adj))
          (set! prev-cp cp)]))
     total]
    [else
     ;; no metrics loaded — this shouldn't happen in practice but
     ;; return a rough estimate using old defaults
     (define default-ratio (if (eq? font-metrics-sym 'arial) 0.556 0.500))
     (* (string-length text) default-ratio font-size)]))

;; ============================================================
;; Vertical Metrics Accessors
;; ============================================================

(define (font-line-height-ratio font-metrics-sym)
  "Get the line-height ratio (normal line-height / font-size) for a font.
   Falls back to hardcoded values if metrics not loaded."
  (define fd (resolve-font-key font-metrics-sym))
  (if fd
      (font-data-line-height-ratio fd)
      ;; fallback (old hardcoded values — these are wrong for Times!)
      (if (eq? font-metrics-sym 'arial) 1.15 1.107)))

(define (font-ascender-ratio font-metrics-sym)
  "Get the ascender ratio (hhea.ascender / unitsPerEm) for a font."
  (define fd (resolve-font-key font-metrics-sym))
  (if fd
      (font-data-ascender-ratio fd)
      (if (eq? font-metrics-sym 'arial) 0.905 0.891)))

(define (font-descender-ratio font-metrics-sym)
  "Get the descender ratio (|hhea.descender| / unitsPerEm) for a font."
  (define fd (resolve-font-key font-metrics-sym))
  (if fd
      (font-data-descender-ratio fd)
      (if (eq? font-metrics-sym 'arial) 0.212 0.216)))

;; ============================================================
;; Chrome macOS Line-Height Computation
;; ============================================================

;; Chrome on macOS uses CoreText metrics for system fonts (Times, Helvetica,
;; Menlo/Courier) with a 15% ascent boost for fonts whose natural ascent +
;; descent fits within the em square.  This produces the integer line-heights
;; that getClientRects() reports.  See crbug.com/445830.
;;
;; Formula:
;;   ascent_px  = floor(asc_ratio * fs + 0.5)
;;   descent_px = floor(desc_ratio * fs + 0.5)
;;   if (boost?):  boost = floor((asc + desc) * 0.15 + 0.5)
;;                 ascent_px += boost
;;   line_height = ascent_px + descent_px

(define (chrome-mac-line-height font-metrics-sym font-size)
  "Compute Chrome-macOS-compatible integer line-height for a font and size.
   Uses CoreText ascent/descent ratios + 15% boost for Times and Helvetica.
   Menlo (monospace) has built-in extra leading so no boost is applied.
   Arial-native uses Arial.ttf hhea metrics with separate rounding (no boost)."
  (define-values (asc-ratio desc-ratio apply-boost?)
    (case font-metrics-sym
      [(times times-bold)           (values 3/4 1/4 #t)]           ;; Times: 0.75 / 0.25
      [(arial arial-bold)           (values (/ 1577 2048) (/ 471 2048) #t)]  ;; Helvetica (generic sans-serif)
      [(arial-native arial-native-bold) (values (/ 1854 2048) (/ 434 2048) #f)]  ;; Arial.ttf hhea metrics
      [(mono mono-bold)             (values (/ 1901 2048) (/ 483 2048) #f)]  ;; Menlo (no boost)
      [else                         (values 3/4 1/4 #t)]))           ;; default: Times
  (define asc-px  (inexact->exact (floor (+ (* asc-ratio font-size) 1/2))))
  (define desc-px (inexact->exact (floor (+ (* desc-ratio font-size) 1/2))))
  (define boosted-asc
    (if apply-boost?
        (+ asc-px (inexact->exact (floor (+ (* (+ asc-px desc-px) 3/20) 1/2))))
        asc-px))
  (+ boosted-asc desc-px))
