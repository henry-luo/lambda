#lang racket/base
;; R7RS Benchmark: fft
;; Fast Fourier Transform from "Numerical Recipes in C"
;; 1 iteration on 4096-element vector. Expected: 0.0

(define PI2 6.28318530717959)

(define (four1 data n)
  (let ((i 0) (j 0))
    ;; bit-reversal
    (let loop-br ((i 0) (j 0))
      (when (< i n)
        (when (< i j)
          (let ((ti (vector-ref data i))
                (ti1 (vector-ref data (+ i 1)))
                (tj (vector-ref data j))
                (tj1 (vector-ref data (+ j 1))))
            (vector-set! data i tj)
            (vector-set! data (+ i 1) tj1)
            (vector-set! data j ti)
            (vector-set! data (+ j 1) ti1)))
        (let collapse ((m (quotient n 2)) (j j))
          (if (and (>= m 2) (>= j m))
              (collapse (quotient m 2) (- j m))
              (loop-br (+ i 2) (+ j m))))))
    ;; Danielson-Lanczos
    (let loop-dl ((mmax 2))
      (when (< mmax n)
        (let* ((theta (/ PI2 (exact->inexact mmax)))
               (sin-half (sin (* 0.5 theta)))
               (wpr (* -2.0 sin-half sin-half))
               (wpi (sin theta)))
          (let loop-m ((m2 0) (wr 1.0) (wi 0.0))
            (when (< m2 mmax)
              (let loop-i ((ii m2))
                (when (< ii n)
                  (let* ((jj (+ ii mmax))
                         (tempr (- (* wr (vector-ref data jj))
                                   (* wi (vector-ref data (+ jj 1)))))
                         (tempi (+ (* wr (vector-ref data (+ jj 1)))
                                   (* wi (vector-ref data jj)))))
                    (vector-set! data jj (- (vector-ref data ii) tempr))
                    (vector-set! data (+ jj 1) (- (vector-ref data (+ ii 1)) tempi))
                    (vector-set! data ii (+ (vector-ref data ii) tempr))
                    (vector-set! data (+ ii 1) (+ (vector-ref data (+ ii 1)) tempi))
                    (loop-i (+ ii mmax mmax)))))
              (let ((new-wr (+ (- (* wr wpr) (* wi wpi)) wr)))
                (loop-m (+ m2 2)
                        new-wr
                        (+ (* wi wpr) (* wr wpi) wi))))))
        (loop-dl (* mmax 2))))))

(define (benchmark)
  (let ((data (make-vector 4096 0.0)))
    (four1 data 4096)
    (vector-ref data 0)))

(define start-time (current-inexact-milliseconds))
(define result (benchmark))
(define elapsed (- (current-inexact-milliseconds) start-time))
(if (= result 0.0)
    (displayln "fft: PASS")
    (begin (display "fft: FAIL result=") (displayln result)))
(display "TIME_MS=") (displayln elapsed)
